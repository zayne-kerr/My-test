<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Conversation Info2</title>
</head>
<body>
  <h2>Conversation Info2</h2>
  <p><strong>Conversation ID:</strong> <span id="conversationId">Loading...</span></p>
  <p><strong>Status:</strong> <span id="statusText">Checking authentication...</span></p>
  <button id="fetchBtn" disabled>Fetch Conversation</button>
  <pre id="responseOutput"></pre>

 <script>
document.addEventListener("DOMContentLoaded", () => {
  const CLIENT_ID = "277e7dba-0dc0-4066-9f5b-0db9f909ae5b";
  const REDIRECT_URI = "https://zayne-kerr.github.io/My-test/test.html";
  const AUTH_URL = "https://login.mypurecloud.ie/oauth/authorize";
  const SCOPES = "conversation:call:view conversation:call:edit";

  const statusText = document.getElementById("statusText");
  const fetchBtn = document.getElementById("fetchBtn");
  const output = document.getElementById("responseOutput");

  const urlParams = new URLSearchParams(window.location.search);
  const conversationId = urlParams.get("cid");
  document.getElementById("conversationId").textContent = conversationId || "Not found";

  // --- Token management ---
  const hash = window.location.hash.substring(1);
  const params = new URLSearchParams(hash);
  let token = params.get("access_token");

  if (token) {
    console.log("‚úÖ Got token from hash");
    sessionStorage.setItem("gc_token", token);
    // Clean up hash (very important)
    window.location.replace(window.location.origin + window.location.pathname + window.location.search);
    return;
  }

  token = sessionStorage.getItem("gc_token");

  if (!token) {
    console.log("üîÑ Redirecting for token...");
    statusText.textContent = "Redirecting to Genesys Cloud login...";
    const authUrl =
      `${AUTH_URL}?response_type=token` +
      `&client_id=${encodeURIComponent(CLIENT_ID)}` +
      `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
      `&scope=${encodeURIComponent(SCOPES)}`;
    window.location.href = authUrl;
    return;
  }

  // --- Ready to use ---
  console.log("‚úÖ Authenticated");
  statusText.textContent = "Authenticated ‚úÖ";
  fetchBtn.disabled = false;

  fetchBtn.addEventListener("click", async () => {
    if (!conversationId) {
      alert("Missing conversation ID (?cid=...)");
      return;
    }

    statusText.textContent = "Calling API...";
    try {
      const response = await fetch(`https://api.mypurecloud.ie/api/v2/conversations/calls/${conversationId}`, {
        method: "POST",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          callNumber: "0832295724",
          phoneColumn: "MSISDN2",
        }),
      });

      const data = await response.json();
      output.textContent = JSON.stringify(data, null, 2);
      statusText.textContent = response.ok ? "API call successful ‚úÖ" : `API error ‚ö†Ô∏è (${response.status})`;
    } catch (err) {
      output.textContent = "Error: " + err.message;
      statusText.textContent = "Error occurred ‚ùå";
    }
  });
});
</script>

</body>
</html>
