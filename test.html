<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Conversation Info</title>
</head>
<body>
  <h2>Conversation Info</h2>
  <p><strong>Conversation ID:</strong> <span id="conversationId">Loading...</span></p>
  <p><strong>Status:</strong> <span id="statusText">Checking authentication...</span></p>
  <button id="fetchBtn" disabled>Fetch Conversation</button>
  <pre id="responseOutput"></pre>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      // --- CONFIG ---
      const CLIENT_ID = "277e7dba-0dc0-4066-9f5b-0db9f909ae5b";
      const REDIRECT_URI = "https://zayne-kerr.github.io/My-test/test.html";
      const AUTH_URL = "https://login.mypurecloud.ie/oauth/authorize";
      const SCOPES = "conversation:call:view conversation:call:edit";

      // --- UI elements ---
      const statusText = document.getElementById("statusText");
      const output = document.getElementById("responseOutput");
      const fetchBtn = document.getElementById("fetchBtn");
      const cidText = document.getElementById("conversationId");

      // --- Get Conversation ID ---
      const urlParams = new URLSearchParams(window.location.search);
      const conversationId = urlParams.get("cid");
      cidText.textContent = conversationId || "Not found";

      // --- Token Helpers ---
      function getTokenFromHash() {
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        return params.get("access_token");
      }

      function saveToken(token) {
        sessionStorage.setItem("gc_token", token);
      }

      function getToken() {
        return sessionStorage.getItem("gc_token");
      }

      // --- Main Auth Flow ---
      let token = getTokenFromHash();
      if (token) {
        saveToken(token);
        // Remove token from URL hash
        window.history.replaceState({}, document.title, window.location.pathname + window.location.search);
      }

      token = getToken();

      if (!token) {
        statusText.textContent = "Redirecting to Genesys Cloud login...";
        const authUrl = `${AUTH_URL}?response_type=token&client_id=${encodeURIComponent(
          CLIENT_ID
        )}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(
          SCOPES
        )}&state=xyz`;
        window.location.href = authUrl;
        return;
      }

      statusText.textContent = "Authenticated ✅";
      fetchBtn.disabled = false;

      // --- Call API ---
      fetchBtn.addEventListener("click", async () => {
        if (!conversationId) {
          alert("Missing conversation ID (?cid=...)");
          return;
        }

        statusText.textContent = "Calling API...";
        output.textContent = "";

        try {
          const response = await fetch(
            `https://api.mypurecloud.ie/api/v2/conversations/calls/${conversationId}`,
            {
              method: "POST",
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                callNumber: "0832295724",
                phoneColumn: "MSISDN2",
              }),
            }
          );

          const data = await response.json();
          output.textContent = JSON.stringify(data, null, 2);
          statusText.textContent = response.ok
            ? "API call successful ✅"
            : `API error ⚠️ (${response.status})`;
        } catch (err) {
          output.textContent = "Error: " + err.message;
          statusText.textContent = "Error occurred ❌";
        }
      });
    });
  </script>
</body>
</html>
