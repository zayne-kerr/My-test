<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Genesys Cloud Demo – Version: 8</title>
  <style>
    body { font-family: system-ui; margin: 2rem; }
    h1 { font-size: 1.2rem; margin-bottom: 1rem; }
    button { 
      padding: 10px 18px; 
      font-size: 16px; 
      border: none; 
      border-radius: 6px; 
      background: #007bff; 
      color: white; 
      cursor: pointer; 
      margin-right: 8px; 
      margin-top: 8px;
    }
    pre { background: #f4f4f4; padding: 10px; border-radius: 6px; margin-top: 1rem; white-space: pre-wrap; }
    .field { font-weight: bold; margin-top: 8px; }
  </style>
</head>
<body>
  <h1>Version: 8</h1>
  <p><strong>Conversation ID:</strong> <span id="cidValue">(none)</span></p>

  <div id="authSection">
    <button id="loginBtn">Login</button>
  </div>

  <div id="apiSection" style="display:none;">
    <button id="btnGetConversation">Get Conversation</button>
    <button id="btnGetOutbound">Get Outbound Record</button>
    <button id="btnUpdateContact">Update Contact</button>
    <button id="btnManualCall">Manual Call</button>
  </div>

  <div id="responseSection">
    <div class="field">Output:</div>
    <pre id="output">(no response yet)</pre>
  </div>

  <script>
    const CLIENT_ID = "277e7dba-0dc0-4066-9f5b-0db9f909ae5b";
    const BASE_URI = window.location.origin + window.location.pathname;
    const AUTH_URL = "https://login.mypurecloud.ie/oauth/authorize";
    const API_HOST = "https://api.mypurecloud.ie";

    const output = document.getElementById("output");
    const cidSpan = document.getElementById("cidValue");
    const loginBtn = document.getElementById("loginBtn");
    const apiSection = document.getElementById("apiSection");
    const authSection = document.getElementById("authSection");

    const btnGetConversation = document.getElementById("btnGetConversation");
    const btnGetOutbound = document.getElementById("btnGetOutbound");
    const btnUpdateContact = document.getElementById("btnUpdateContact");
    const btnManualCall = document.getElementById("btnManualCall");

    let accessToken = null;
    let dialerContactId = null;
    let dialerContactListId = null;

    // --- Handle Conversation ID ---
    const urlParams = new URLSearchParams(window.location.search);
    let cid = urlParams.get("cid");
    if (cid) sessionStorage.setItem("cid", cid);
    else cid = sessionStorage.getItem("cid");
    cidSpan.textContent = cid ? cid : "(none)";

    // --- Handle Token ---
    const hash = window.location.hash;
    if (hash.includes("access_token")) {
      const params = new URLSearchParams(hash.substring(1));
      accessToken = params.get("access_token");
      window.history.replaceState({}, document.title, window.location.href.split("#")[0]);
      authSuccess();
    }

    // --- Login Button ---
    loginBtn.onclick = () => {
      if (cid) sessionStorage.setItem("cid", cid);
      const authUrl = `${AUTH_URL}?response_type=token&client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(BASE_URI)}&force_login=false`;
      window.location = authUrl;
    };

    function authSuccess() {
      authSection.style.display = "none";
      apiSection.style.display = "block";
      output.textContent = "✅ Logged in.\nReady to call APIs.";
    }

    // --- Button 1: Get Conversation ---
    btnGetConversation.onclick = async () => {
      if (!cid) { output.textContent = "No Conversation ID found."; return; }
      output.textContent = "Getting callback conversation details...";
      try {
        const resp = await fetch(`${API_HOST}/api/v2/conversations/callbacks/${cid}`, {
          headers: { Authorization: `Bearer ${accessToken}` }
        });
        const data = await resp.json();
        if (!resp.ok) {
          output.textContent = `Error ${resp.status}: ${JSON.stringify(data, null, 2)}`;
          return;
        }

        // Get nested attributes
        const participant = data.participants && data.participants[0];
        if (participant && participant.attributes) {
          dialerContactId = participant.attributes.dialerContactId || "(none)";
          dialerContactListId = participant.attributes.dialerContactListId || "(none)";
        } else {
          dialerContactId = "(none)";
          dialerContactListId = "(none)";
        }

        output.textContent = `✅ Callback Conversation Retrieved\n\nDialer Contact ID: ${dialerContactId}\nDialer Contact List ID: ${dialerContactListId}`;
      } catch (err) {
        output.textContent = "Error: " + err;
      }
    };

    // --- Button 2: Get Outbound Record ---
    btnGetOutbound.onclick = async () => {
      if (!accessToken) { output.textContent = "Not logged in."; return; }
      if (!dialerContactId || !dialerContactListId) { 
        output.textContent = "Please run 'Get Conversation' first to retrieve Contact IDs."; 
        return; 
      }

      output.textContent = "Fetching outbound contact record...";
      try {
        const resp = await fetch(`${API_HOST}/api/v2/outbound/contactlists/${dialerContactListId}/contacts/${dialerContactId}`, {
          method: "GET",
          headers: { 
            "Authorization": `Bearer ${accessToken}`,
            "Content-Type": "application/json"
          }
        });
        const data = await resp.json();
        if (!resp.ok) {
          output.textContent = `Error ${resp.status}: ${JSON.stringify(data, null, 2)}`;
          return;
        }

        output.textContent = `✅ Outbound Contact Record Retrieved\n\n${JSON.stringify(data, null, 2)}`;
      } catch (err) {
        output.textContent = "Error: " + err;
      }
    };

    // --- Button 3: Update Contact (placeholder) ---
    btnUpdateContact.onclick = () => {
      output.textContent = "✏️ Update Contact API will be implemented once endpoint details are supplied.";
    };

    // --- Button 4: Manual Call (placeholder) ---
    btnManualCall.onclick = () => {
      output.textContent = "📲 Manual Call API will be implemented once endpoint details are supplied.";
    };
  </script>
</body>
</html>
